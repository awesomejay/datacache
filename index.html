<!DOCTYPE html>
<html>
<head>
	<title>tsds_fe</title>
	<link rel="stylesheet" type="text/css" href="asset/bootstrap.css">
	<style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }

      textarea {
      	width: 90%;
      }
      input {
      	width : 40px;
      	margin : 0 0 9px;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="asset/bootstrap-responsive.css">
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript">
	$(document).ready(function(){
		$('#urlForm').on('submit', function(e) {
		    e.preventDefault(); // prevent native submit
		    $(this).ajaxSubmit({
		        success: function(res){
		        	$("#result").prepend($("<div/>", {id : res.id, class : "jobMonitor"}));
		        	jobMonitor(res);
		        }
		    })
		});

		// $('#paramsForm').on('submit', function(e) {
		//     e.preventDefault(); // prevent native submit
		//     $(this).ajaxSubmit();
		// });

		$.getJSON("/api/presets", function(data){
			data.forEach(function(d){
				var a = $("<a>")
					.attr("href", "#")
					.click(function(){
						$("#urls").val(d.urls);
					})
					.html(d.name);
				$("#presets").append(a);
				$("#presets").append("&nbsp;");
			})
		})
	})

	function jobMonitor(job){
		$.ajax({
			url : "/status/job/"+job.id,
			success : function(data){
				var status = "<h3>Job " + job.id;
				var details = data.works.map(function(d){
					if(d.error){
						return "URL: "+d.url+"<br><font color='red'>Error:"+d.error+"</font><br>Tried " + (d.tries || 1) + " times";
					} else {
						var cacheUrl = "/cache/"+d.url.split("/")[2]+"/"+d.urlMd5;
						return "URL: "+d.url
							 + (d.isFromCache ? "<br><font color='orange'>Found in cache.</font>" : "")
							+"<br>Time: <font color='green'>"+d.time + "ms</font>"
							+"<br> md5: "+d.md5
							+"<br> File: <a target='_blank' href='"+ cacheUrl+".data'>data</a> | <a target='_blank' href='"
							+cacheUrl+".out'> response </a>  | <a target='_blank' href='"
							+cacheUrl+".header'> header </a> | <a target='_blank' href='"
							+cacheUrl + ".log'> log </a>";
					}
				}).join('<br><br>');
				if(data.isFinished){
					status += " has finished. "+data.time+"ms </h3>"+details;
				} else {
					status += " is running ";
					var count = 0;
					data.works.forEach(function(work){
						if(work.isFinished){
							count++;
						}
					});
					status +="("+count+"/"+job.num+") </h3>"+details;
					setTimeout(function(){jobMonitor(job);}, 300);
				}
				$("#"+job.id).html(status);
			}
		})
	}
	</script>
</head>
<body>
 <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="#">TSDS_FE</a>
      <div class="nav-collapse">
        <ul class="nav">
          <li class="active"><a href="#" target='_blank'>Home</a></li>
          <li><a href="/cache" target='_blank'>Cache</a></li>
          <li><a href="https://github.com/weiribao/tsds_fe" target='_blank'>Source</a></li>
          <li><a href="/log" target='_blank'>Log</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>
<div class="container">
	      <!-- Main hero unit for a primary marketing message or call to action -->
<!--       <div class="hero-unit">
        <h1>Hello, world!</h1>
        <p>This is a template for a simple marketing or informational website. It includes a large callout called the hero unit and three supporting pieces of content. Use it as a starting point to create something more unique.</p>
        <p><a class="btn btn-primary btn-large">Learn more &raquo;</a></p>
      </div> -->

	<div class="row">
		<div class="span6">
<!-- 			<div class="row">
				<h2>System parameters</h2>
				<form id="paramsForm" action="/api/setParams" method="post">
					<p>
						Concurrency(1-1000): <input type="text" name="concurrency" size="3" value="1000"/> &nbsp; &nbsp; &nbsp;
						Max # of tries: <input type="text" name="tries" size="3" value="3"/> &nbsp; &nbsp; &nbsp;
						Timeout: <input type="text" name="timeout" size="3" value="50000"/> &nbsp; &nbsp; &nbsp;
						<input type='submit' value="Set"/> 
					</p>
				</form>
			</div> -->
			<div class="row">
				<h2>Submit URLs</h2>
				<form id="urlForm" action="/submit" method="post">
				<p>Urls: (Presets: <span id="presets"></span>)
				</p>
				<p>
					<textarea id='urls' rows='30' cols='100' name='source'></textarea>
				</p>
				<p>
					<input type='submit'/> &nbsp; &nbsp; &nbsp;
					<input type='checkbox' name='forceUpdate' value='true' > Update <a href='cache'>cache</a> &nbsp; &nbsp; &nbsp;
					<input type='checkbox' name='acceptGzip' value='true' > accept-encoding: gzip, compress</input> 
					
				</p>
			</form>
			</div>		
		</div>

		<div class="span6">	
			<div class="row">
				<h2>Log:</h2>
				<a href="#" onClick="$('#result').html('')"> Clear </a>	
				<div id="result">

				
				</div>
			</div>
			
		</div>
	
	</div>


    <hr>

   <footer>
    <p>&copy; 2012</p>
   </footer>
</div>
	
<script type="text/javascript" src="asset/jquery.form.js"></script>
<script type="text/javascript" src="asset/preset.js"></script>
<script type="text/javascript" src="asset/bootstrap.min.js"></script>
</body>
</html>